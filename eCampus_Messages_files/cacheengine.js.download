define(["ncf-thirdparty/jquery-1.7.1/public/javascript/jquery","ncf-caching/1.0.2/public/javascript/relay","ncf-thirdparty/json-2/public/javascript/json"],function(a,b,c){var d=function(a,b){return a+6e3*(b||0)},e=function(a,b){return a+864e5*(b||0)},f=function(a,b){return a+36e5*(b||0)},g="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||g.trim()){g="["+g+"]";var h=new RegExp("^"+g+g+"*"),i=new RegExp(g+g+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(h,"").replace(i,"")}}var j=function(a,b){var c=[];for(var d in a)b.test(d)&&c.push(a[d]);return c},k=window.localStorage||{};setInterval(function(){for(var a=j(k,/\@\@cachemeta/),b=0;b<a.length;b++){var d=c.parse(a[b]);n(d)&&p(d).get(!0)}},3e4);var l={};b.receiveMessage(function(a){var b=null;try{0===a.data.indexOf("ready:")?b=l[a.data.substring(6,a.data.length)].shift():l[a.origin]&&(b=l[a.origin].shift()),b&&b.cb&&b.cb(""===a.data.trim()?null:c.parse(a.data)),b.resolve()}catch(d){}},function(a){return l[a.origin]});var m=function(d,e,f){var g=f;if(g&&-1===window.location.href.indexOf(g)){var h=b.createCommChannel(g+"/te/ncf-caching/1.0.2/public/javascript/cdr.html");return g=g.replace("/build/",""),l[g]||(l[g]=[a.Deferred()]),{set:function(c){a.when.apply(a,l[g]).then(function(){b.postMessage("put"+d.replace("Storage","")+":::"+e+":::"+c,f,window.frames[h])}),l[g].push(a.Deferred())},get:function(c){var i=a.Deferred();i.cb=c,a.when.apply(a,l[g]).then(function(){b.postMessage("get"+d.replace("Storage","")+":::"+e,f,window.frames[h])}),l[g].push(i)}}}return{set:function(a){window[d][e]=a},get:function(a){var b;try{"undefined"!=typeof window[d][e]&&(b=c.parse(window[d][e]))}catch(f){}a&&a(b)}}},n=function(b){var c,g=b[b.basedOn];return b.expired||(c=e(g,b.durationDays),c=f(c,b.durationHours),c=d(c,b.durationHours),b.expired=c<a.now()),b.expired},o=function(a,b){try{return n(a)&&!b&&a.refresh&&(ret=a.refresh()),a}catch(c){return!1}},p=function(b,d){var e,f=b,g=m(f.area,f.cid,f.domain),h=null;return h={clear:function(){try{return h.set({}),d.mark({modified:a.now()}),!0}catch(b){return!1}},get:function(a,b){try{e=o(f,a),e?g.get(b):h.clear()}catch(c){}},set:function(b){var e,i,j=!1,k=o(f),l=a.now();try{k?(e=c.stringify(b),i=e.length,5e5>i&&(g.set(e),d.mark({modified:l,size:i}),j=!0)):h.clear()}catch(m){}return j}}},q=function(b,d){var e,f,g=b+"@@cachemeta",h=function(b){var d=c.parse(k[g]),e=a.extend(d,b||{},{touched:a.now()});return j(e,!0),e},i=function(){try{return h(d)}catch(a){return!1}},j=function(b,d){try{return k[g]=c.stringify(b),d?b:h({modified:a.now()})}catch(e){return!1}},l=a.now(),m={cid:b,durationHours:4,area:"sessionStorage",created:l,modified:l,touched:l,basedOn:"created"};return k[g]?f=i():(f=a.extend(m,d||{}),j(f)),e={getMeta:i,setMeta:j,mark:h},e.isExpired=function(){var a=e.getMeta();return n(a)&&e.setMeta(a),a.expired},e};return{get:function(a,b,c){var d=a+"..."+b,e=q(d,c),f=function(){var a=e.getMeta(),b=p(a,e);return a.isExpired&&b.set({}),b};return f(),function(){var a=[];return{clear:function(){return f().clear()},snapshot:function(b){for(var c=f(),d=0;d<a.length;d++)c.get(a[d]);b&&c.get(!1,b)},on:function(b,c){"snapshot"===b&&a.push(c)},set:function(a,b){var c,d=f();return"object"==typeof a?d.set(a):"number"==typeof a||(c=d.get()||{},c[a]=b,d.set(c)),!0}}}()}}});